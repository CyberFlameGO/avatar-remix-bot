## avatar-remix

**Install demo bot:** https://discord.com/oauth2/authorize?client_id=1067310785468043285&scope=applications.commands+bot

Avatar Remix is a Discord bot that lets you edit your friends' profile pictures in fun and sometimes unexpected ways.

![avatar remix example](https://www.ianww.com/avatar-remix/catluvr2.png)

## How it works

The main functionality of Avatar Remix is provided by [instruct-pix2pix](https://www.timothybrooks.com/instruct-pix2pix), a model based on Stable Diffusion fine-tuned on a large dataset of example prompts generated by GPT-3.

Discord profile pictures are often pretty small, so if necessary we use [Real-ESRGAN](https://github.com/xinntao/Real-ESRGAN) to upscale for better results.

This app runs as a Cloudflare Worker and uses the [Replicate](https://replicate.com/) API to run the above models serverlessly.

![request flow](https://kroki.io/mermaid/svg/eNqVjzEOwjAMRfecIhfowlqJEzBxActNTCkNSbFjwfFJIgZQqRCDh299-_83Mi5nezj2xqgQA9NNSbLtur11Iak_BWSCe-KZuDerVTOi95ATlEul8oiER4zgMIQB3fzfL8nIGaYomdVlWKbHrgxc0tCb1fZXxFYGRV9IRUOuvSt4rR0bgK9ZzdYkuBRFr8TmU76VffG2ipumr0RPimmNGA==)

## Setup

### Create an application

Create a new application on the [Discord Developer portal](https://discord.com/developers/applications).

Then, create a bot associated with the application (we don't actually use this bot, we just use its token for convenience...)

See the [Getting Started](https://discord.com/developers/docs/getting-started) guide on the Discord developer portal for more details.

### Envars and secrets

Set up envars in `wrangler.toml`. You'll have to update `DISCORD_APPLICATION_ID` and `DISCORD_PUBLIC_KEY` with values from the application you just created.

You'll also have to update `WORKER_BASE_URL` with the URL of your Cloudflare worker. By default, this URL takes the form `https://avatar-remix-bot.<your worker username>.workers.dev`.

Use wrangler to set secret tokens for your bot and for replicate:

```
wrangler secret put DISCORD_BOT_TOKEN
wrangler secret put REPLICATE_API_TOKEN
```

### KV store and Queues

This bot uses Cloudflare to host some serverless infra.

First, it uses [Workers KV](https://developers.cloudflare.com/workers/runtime-apis/kv/) in order to track Replicate jobs and match callbacks with the original jobs:

```
wrangler kv:namespace create AVATAR_REMIX_FOLLOWUPS
```

Second, it uses [Cloudflare Queues](https://developers.cloudflare.com/queues/platform/javascript-apis/) to stay within Replicate rate limits during periods of heavy load (this isn't necessary unless you think a lot of people will use your app):

```
wrangler queues create AVATAR_REMIX_JOBS
```

### Register slash commands

Register your slash commands by hitting the register endpoint:

```
curl -X POST https://username.workers.dev/register
```

You'll have to do this any time you've deployed a change to commands.ts.
